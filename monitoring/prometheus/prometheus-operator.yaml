apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: prometheus
  namespace: monitoring
  annotations:
    fluxcd.io/automated: "true"
spec:
  releaseName: prometheus-operator
  helmVersion: v3
  rollback:
    enable: false
  chart:
    repository: https://kubernetes-charts.storage.googleapis.com/
    name: prometheus-operator
    version: v9.1.0
  values:
    defaultRules:
      rules:
        kubeApiserverAvailability: false
        kubeApiserver: false
    server:
      resources:
        requests:
          memory: 1500Mi
          cpu: 25m
        limits:
          memory: 2000Mi
    nodeExporter:
      serviceMonitor:
        relabelings:
        - action: replace
          regex: (.*)
          replacement: $1
          sourceLabels:
          - __meta_kubernetes_pod_node_name
          targetLabel: kubernetes_node
    kubelet:
      serviceMonitor:
        metricRelabelings:
        - action: replace
          sourceLabels:
          - node
          targetLabel: instance
    kubeStateMetrics:
      enabled: true
    
    grafana:
      deploymentStrategy:
        type: Recreate
      #podAnnotations:
      #  backup.velero.io/backup-volumes: storage
      persistence:
        enabled: true
        storageClassName: "rook-ceph-block"
        size: 10Gi
        accessModes:
        - ReadWriteOnce

      ingress:
        enabled: true

      plugins:
        - natel-discrete-panel
        - pr0ps-trackmap-panel
        - grafana-piechart-panel
        - https://github.com/panodata/grafana-map-panel/releases/download/0.9.0/grafana-map-panel-0.9.0.zip;grafana-worldmap-panel-ng
      
      #additionalDataSources:
      #- name: Teslamate
      #  type: postgresql
      #  access:
      #  url:
      #  database: 

      dashboardProviders:
        dashboardproviders.yaml:
          apiVersion: 1
          providers:
          - name: 'default'
            orgId: 1
            folder: ''
            type: file
            disableDeletion: false
            allowUiUpdates: true
            editable: true
            options:
              path: /var/lib/grafana/dashboards/default
          - name: teslamate
            orgId: 1
            folder: Teslamate
            type: file
            disableDeletion: false
            editable: true
            allowUiUpdates: true
            options:
              path: /var/lib/grafana/dashboards/teslamate
      
      dashboards:
        default:
          nginx-dashboard:
            url: https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/grafana/dashboards/nginx.json
            datasource: Prometheus
          ceph-cluster:
            url: https://grafana.com/api/dashboards/2842/revisions/11/download
            datasource: Prometheus
          ceph-osd:
            url: https://grafana.com/api/dashboards/5336/revisions/3/download
            datasource: Prometheus
          ceph-pools:
            url: https://grafana.com/api/dashboards/5342/revisions/3/download
            datasource: Prometheus
          
        teslamate:
          charge-level:
            url: https://raw.githubusercontent.com/adriankumpf/teslamate/v1.19.4/grafana/dashboards/charge-level.json
            # datasource: TeslaMate
          charges:
            url: https://raw.githubusercontent.com/adriankumpf/teslamate/v1.19.4/grafana/dashboards/charges.json
            # datasource: TeslaMate
          charging-stats:
            url: https://raw.githubusercontent.com/adriankumpf/teslamate/v1.19.4/grafana/dashboards/charging-stats.json
            # datasource: TeslaMate
          drive-stats:
            url: https://raw.githubusercontent.com/adriankumpf/teslamate/v1.19.4/grafana/dashboards/drive-stats.json
            # datasource: TeslaMate
          drives:
            url: https://raw.githubusercontent.com/adriankumpf/teslamate/v1.19.4/grafana/dashboards/drives.json
            # datasource: TeslaMate
          efficiency:
            url: https://raw.githubusercontent.com/adriankumpf/teslamate/v1.19.4/grafana/dashboards/efficiency.json
            # datasource: TeslaMate
          locations:
            url: https://raw.githubusercontent.com/adriankumpf/teslamate/v1.19.4/grafana/dashboards/locations.json
            # datasource: TeslaMate
          mileage:
            url: https://raw.githubusercontent.com/adriankumpf/teslamate/v1.19.4/grafana/dashboards/mileage.json
            # datasource: TeslaMate
          overview:
            url: https://raw.githubusercontent.com/adriankumpf/teslamate/v1.19.4/grafana/dashboards/overview.json
            # datasource: TeslaMate
          projected-range:
            url: https://raw.githubusercontent.com/adriankumpf/teslamate/v1.19.4/grafana/dashboards/projected-range.json
            # datasource: TeslaMate
          states:
            url: https://raw.githubusercontent.com/adriankumpf/teslamate/v1.19.4/grafana/dashboards/states.json
            # datasource: TeslaMate
          trip:
            url: https://raw.githubusercontent.com/adriankumpf/teslamate/v1.19.4/grafana/dashboards/trip.json
            # datasource: TeslaMate
          updates:
            url: https://raw.githubusercontent.com/adriankumpf/teslamate/v1.19.4/grafana/dashboards/updates.json
            # datasource: TeslaMate
          vampire-drain:
            url: https://raw.githubusercontent.com/adriankumpf/teslamate/v1.19.4/grafana/dashboards/vampire-drain.json
            # datasource: TeslaMate
          visited:
            url: https://raw.githubusercontent.com/adriankumpf/teslamate/v1.19.4/grafana/dashboards/visited.json
            # datasource: TeslaMate
          charge-details:
            url: https://raw.githubusercontent.com/adriankumpf/teslamate/v1.19.4/grafana/dashboards/internal/charge-details.json
          drive-details:
            url: https://raw.githubusercontent.com/adriankumpf/teslamate/v1.19.4/grafana/dashboards/internal/drive-details.json
        
        network:
          speedtest:
            url: https://raw.githubusercontent.com/billimek/prometheus-speedtest-exporter/master/speedtest-exporter.json
            datasource: speedtests
    
      sidecar:
        datasources:
          enabled: true
          defaultDatasourceEnabled: false
        dashboards:
          enabled: true
          searchNamespace: ALL

      additionalDataSources:
      - name: speedtests
        type: influxdb
        access: proxy
        url: http://influxdb:8086
        database: speedtests
    
    prometheus:
      ingress:
        enabled: true

  valuesFrom:
    - secretKeyRef:
        name: prometheus-operator-helm-values